# Nginx Configuration for Infrastructure Services
# File: /etc/nginx/sites-available/qa-infrastructure
# Domain: sabresoftware.com.br
# Subdomain Pattern: qa-{service}.sabresoftware.com.br

# ============================================================
# JENKINS - CI/CD Server
# ============================================================

upstream jenkins {
    server localhost:8080;
}

# Jenkins - HTTP to HTTPS redirect
server {
    listen 80;
    server_name qa-jenkins.sabresoftware.com.br;
    return 301 https://$server_name$request_uri;
}

# Jenkins - HTTPS
server {
    listen 443 ssl http2;
    server_name qa-jenkins.sabresoftware.com.br;

    # SSL Configuration (wildcard certificate for *.sabresoftware.com.br)
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/_.sabresoftware.com.br_private_key_mar25.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Logging
    access_log /var/log/nginx/jenkins-access.log;
    error_log /var/log/nginx/jenkins-error.log;

    # Jenkins Proxy Configuration
    location / {
        proxy_pass http://jenkins;
        proxy_http_version 1.1;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        proxy_cache_bypass $http_upgrade;

        # Jenkins-specific settings
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_read_timeout 90s;
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
    }
}

# ============================================================
# PORTAINER - Docker Management UI
# ============================================================

upstream portainer {
    server localhost:9443;
}

# Portainer - HTTP to HTTPS redirect
server {
    listen 80;
    server_name qa-portainer.sabresoftware.com.br;
    return 301 https://$server_name$request_uri;
}

# Portainer - HTTPS
server {
    listen 443 ssl http2;
    server_name qa-portainer.sabresoftware.com.br;

    # SSL Configuration (wildcard certificate for *.sabresoftware.com.br)
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/_.sabresoftware.com.br_private_key_mar25.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Logging
    access_log /var/log/nginx/portainer-access.log;
    error_log /var/log/nginx/portainer-error.log;

    # Portainer Proxy Configuration
    location / {
        proxy_pass https://portainer;
        proxy_http_version 1.1;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 90s;

        # Portainer requires this for HTTPS backend
        proxy_ssl_verify off;
    }
}

# ============================================================
# SETUP INSTRUCTIONS
# ============================================================

# ============================================================
# QA-HARBOR - Registry Proxy (qa-harbor.sabresoftware.com.br)
# Proxies requests to the `registry` service running on the
# `infrastructure` overlay network (registry:5000).
# ============================================================

upstream qa_harbor_upstream {
    server 127.0.0.1:5000;
}

server {
    listen 80;
    server_name qa-harbor.sabresoftware.com.br;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name qa-harbor.sabresoftware.com.br;

    # SSL (use your wildcard certs or certs specific to this host)
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/_.sabresoftware.com.br_private_key_mar25.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    access_log /var/log/nginx/qa-harbor-access.log;
    error_log /var/log/nginx/qa-harbor-error.log;

    location / {
        proxy_pass http://qa_harbor_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
        proxy_connect_timeout 30s;
    }

    # Docker Registry API expects certain headers; make sure they are preserved
    location /v2/ {
        proxy_pass http://qa_harbor_upstream/v2/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
    }

    # Registry UI accessible under /ui/
    location /ui/ {
        proxy_pass http://127.0.0.1:8081/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
    }
}

# ============================================================
# Docker Swarm service snippet: add to docs/devops/docker-compose.infra.yaml
# This creates an `nginx-proxy` service attached to the `infrastructure` network
# and mounts this configuration and SSL certs into the container.
# ============================================================

#
# nginx-proxy:
#   image: nginx:stable-alpine
#   networks:
#     - infrastructure
#   ports:
#     - target: 80
#       published: 80
#       protocol: tcp
#       mode: host
#     - target: 443
#       published: 443
#       protocol: tcp
#       mode: host
#   volumes:
#     - ./docs/devops/qa-infra-nginx.conf:/etc/nginx/conf.d/qa-infrastructure.conf:ro
#     - /etc/nginx/ssl:/etc/nginx/ssl:ro   # <-- ensure your certs are available on the host
#   deploy:
#     mode: replicated
#     replicas: 1
#     placement:
#       constraints:
#         - node.role == manager
#     restart_policy:
#       condition: on-failure
#   labels:
#     - "com.example.service=nginx-proxy"
#
# Notes:
# - Place this snippet under the `services:` section of your infra compose file.
# - Ensure the host path `/etc/nginx/ssl` contains the certificate and key referenced
#   in this config (or change the mount to point to your cert location).
# - The `proxy_pass` uses the service name `registry` (present in the infra stack) so
#   nginx must be attached to the same `infrastructure` overlay network.
# - If you prefer to manage TLS with certbot/Let's Encrypt, run certbot on the manager
#   and mount certs into the container, or use Traefik for automatic certificate management.

#
# 1. Install Nginx:
#    sudo apt install nginx
#
# 2. Copy this file to sites-available:
#    sudo cp nginx-infrastructure.conf /etc/nginx/sites-available/qa-infrastructure
#
# 3. Create symbolic link in sites-enabled:
#    sudo ln -s /etc/nginx/sites-available/qa-infrastructure /etc/nginx/sites-enabled/
#
# 4. Test nginx configuration:
#    sudo nginx -t
#
# 5. Reload nginx:
#    sudo systemctl reload nginx
#
# 6. SSL Certificate:
#    This config uses the existing wildcard certificate at:
#    /etc/nginx/ssl/sabresoftware.com.br_ssl_certificate_mar25.cer
#    /etc/nginx/ssl/_.sabresoftware.com.br_private_key_mar25.key
#
# 7. Verify certificate expiration and renewal process as needed
#
# ============================================================
